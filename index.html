<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, orientation=landscape">
    <title>Digital Piano - Sustain Esticado</title>
    <style>
        :root { --bg: #000; --green: #32CD32; --blue: #1E90FF; --pink: #FF1493; --orange: #FF8C00; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; overflow: hidden; height: 100vh; }

        .header { display: flex; align-items: center; justify-content: space-between; padding: 5px 15px; height: 50px; }
        .btn-sair { background: var(--orange); border: none; color: white; padding: 5px 20px; border-radius: 20px; font-weight: bold; }
        
        .sliders { display: flex; gap: 15px; padding: 0 15px; }
        .slider-item { flex: 1; display: flex; align-items: center; gap: 8px; font-size: 11px; font-weight: bold; }
        input[type="range"] { flex: 1; accent-color: var(--green); height: 10px; background: #333; border-radius: 5px; appearance: none; }

        .buttons { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding: 10px; }
        .btn-act { height: 50px; border: none; border-radius: 25px; color: white; font-weight: bold; font-size: 13px; }
        .btn-mic { background: var(--pink); }
        .btn-mic.recording { background: #fff; color: red; animation: blink 1s infinite; }
        .btn-mic.ready { background: var(--green); color: #000; }

        @keyframes blink { 50% { opacity: 0.5; } }

        .keyboard { display: flex; height: calc(100vh - 210px); padding: 5px; background: #000; position: relative; gap: 2px; }
        .key { flex: 1; background: linear-gradient(#111, #000); border: 1px solid #222; border-radius: 0 0 5px 5px; position: relative; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 15px; color: #555; }
        .key.active { background: var(--green) !important; color: #000 !important; box-shadow: 0 0 30px var(--green); }
        .black-key { position: absolute; background: #000; width: 34px; height: 60%; left: 70%; z-index: 5; border: 1px solid #333; border-radius: 0 0 5px 5px; }
    </style>
</head>
<body>

<div class="header">
    <button class="btn-sair" onclick="location.reload()">SAIR</button>
    <div style="color: var(--green); font-weight: bold;">SUSTAIN: ESTICAR VOZ</div>
    <div style="color: #00BFFF;">‚óè REC</div>
</div>

<div class="sliders">
    <div class="slider-item">PITCH: <input type="range" id="pitch" min="0.5" max="2.0" step="0.01" value="1.0"></div>
    <div class="slider-item">VOL: <input type="range" id="vol" min="0" max="4" step="0.1" value="2.0"></div>
</div>

<div class="buttons">
    <button class="btn-act" style="background:var(--blue)">ECO: OFF</button>
    <button class="btn-act" style="background:var(--purple)">USB: OFF</button>
    <button class="btn-act btn-mic" id="micBtn" onclick="controleGravar()">üé§ GRAVAR (DOOOOCE)</button>
</div>

<div class="keyboard" id="piano"></div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const masterGain = audioCtx.createGain();
    masterGain.connect(audioCtx.destination);

    let recordedBuffer = null;
    let isRecording = false;
    let mediaRecorder = null;
    let activeNodes = {};

    const notas = [
        {f: 261.63, n: 'C'}, {f: 277.18, n: 'C#', b:true},
        {f: 293.66, n: 'D'}, {f: 311.13, n: 'D#', b:true},
        {f: 329.63, n: 'E'},
        {f: 349.23, n: 'F'}, {f: 369.99, n: 'F#', b:true},
        {f: 392.00, n: 'G'}, {f: 415.30, n: 'G#', b:true},
        {f: 440.00, n: 'A'}, {f: 466.16, n: 'A#', b:true},
        {f: 493.88, n: 'B'}
    ];

    const piano = document.getElementById('piano');
    notas.forEach((nota, i) => {
        if(nota.b) return;
        const key = document.createElement('div');
        key.className = 'key';
        key.innerHTML = `<span>${nota.n}</span>`;
        
        if(notas[i+1] && notas[i+1].b) {
            const bKey = document.createElement('div');
            bKey.className = 'black-key';
            bKey.addEventListener('touchstart', (e) => { e.preventDefault(); e.stopPropagation(); iniciarSom(notas[i+1].f, bKey); });
            bKey.addEventListener('touchend', () => pararSom(bKey));
            key.appendChild(bKey);
        }

        key.addEventListener('touchstart', (e) => { e.preventDefault(); iniciarSom(nota.f, key); });
        key.addEventListener('touchend', () => pararSom(key));
        piano.appendChild(key);
    });

    function iniciarSom(freq, elemento) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const pitchVal = document.getElementById('pitch').value;
        const volVal = document.getElementById('vol').value;

        elemento.classList.add('active');

        const gainNode = audioCtx.createGain();
        gainNode.gain.setValueAtTime(volVal, audioCtx.currentTime);

        let source;
        if(!recordedBuffer) {
            source = audioCtx.createOscillator();
            source.type = 'sawtooth';
            source.frequency.value = freq * pitchVal;
        } else {
            source = audioCtx.createBufferSource();
            source.buffer = recordedBuffer;
            source.playbackRate.value = (freq / 261.63) * pitchVal;
            
            // L√≥gica do Sustain: Loopa apenas o finalzinho (√∫ltimos 20%)
            const duracao = recordedBuffer.duration;
            source.loop = true;
            source.loopStart = duracao * 0.8; 
            source.loopEnd = duracao;
        }

        source.connect(gainNode);
        gainNode.connect(masterGain);
        source.start();

        activeNodes[freq] = { source, gainNode, startTime: audioCtx.currentTime };
    }

    function pararSom(elemento) {
        elemento.classList.remove('active');
        const agora = audioCtx.currentTime;

        for (let f in activeNodes) {
            const node = activeNodes[f];
            // Garante o tempo m√≠nimo de 0.3s antes de desligar
            const tempoDecorrido = agora - node.startTime;
            const atraso = Math.max(0, 0.3 - tempoDecorrido);

            node.gainNode.gain.setTargetAtTime(0, agora + atraso, 0.05);
            node.source.stop(agora + atraso + 0.2);
            delete activeNodes[f];
        }
    }

    async function controleGravar() {
        const btn = document.getElementById('micBtn');
        if (!isRecording) {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            let chunks = [];
            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.onstop = async () => {
                const audioData = await (new Blob(chunks)).arrayBuffer();
                audioCtx.decodeAudioData(audioData, b => { 
                    recordedBuffer = b; 
                    btn.className = "btn-act btn-mic ready"; 
                    btn.innerText = "DOOOOCE PRONTO!"; 
                });
            };
            mediaRecorder.start();
            isRecording = true;
            btn.className = "btn-act btn-mic recording";
            btn.innerText = "GRAVANDO...";
        } else {
            mediaRecorder.stop();
            isRecording = false;
        }
    }
</script>
</body>
</html>
