<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, orientation=landscape">
    <title>Piano Digital Pro - Sustain Infinito</title>
    <style>
        :root { --bg: #000; --green: #32CD32; --blue: #1E90FF; --pink: #FF1493; --orange: #FF8C00; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: white; font-family: 'Arial', sans-serif; margin: 0; overflow: hidden; height: 100vh; user-select: none; }

        .header { display: flex; align-items: center; justify-content: space-between; padding: 5px 15px; height: 45px; }
        .btn-sair { background: var(--orange); border: none; color: white; padding: 5px 20px; border-radius: 20px; font-weight: bold; font-size: 11px; cursor: pointer; }
        
        .sliders { display: flex; gap: 15px; padding: 0 15px; }
        .slider-item { flex: 1; display: flex; align-items: center; gap: 8px; font-size: 10px; font-weight: bold; }
        input[type="range"] { flex: 1; accent-color: var(--green); height: 10px; background: #333; border-radius: 5px; appearance: none; }

        .buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 8px; }
        .btn-act { height: 48px; border: none; border-radius: 25px; color: white; font-weight: bold; font-size: 12px; text-transform: uppercase; cursor: pointer; }
        .btn-mic { background: var(--pink); }
        .btn-mic.recording { background: #fff; color: red; animation: blink 0.8s infinite; }
        .btn-mic.ready { background: var(--green); color: #000; }

        @keyframes blink { 50% { opacity: 0.4; } }

        /* Teclado Realista com Scroll */
        .keyboard-wrapper { width: 100%; overflow-x: auto; height: calc(100vh - 190px); background: #111; position: relative; scroll-behavior: smooth; }
        .keyboard { display: flex; min-width: 1400px; height: 100%; position: relative; padding: 0 10px; }
        
        .key { 
            flex: 1; 
            min-width: 80px; 
            background: white; 
            border: 1px solid #999; 
            border-radius: 0 0 8px 8px; 
            position: relative; 
            display: flex; 
            align-items: flex-end; 
            justify-content: center; 
            padding-bottom: 20px; 
            color: #333; 
            font-size: 14px; 
            font-weight: bold; 
            z-index: 1;
            box-shadow: inset 0 -5px 10px rgba(0,0,0,0.1);
        }
        
        .key.active { background: #ccc; box-shadow: inset 0 0 30px var(--green); color: var(--green); }

        .black-key { 
            position: absolute; 
            background: linear-gradient(#333, #000); 
            width: 46px; 
            height: 60%; 
            z-index: 2; 
            border-radius: 0 0 5px 5px; 
            border: 1px solid #000;
            box-shadow: 0 5px 10px rgba(0,0,0,0.5);
        }
        
        .black-key.active { background: #222; box-shadow: inset 0 0 20px var(--green); }
    </style>
</head>
<body>

<div class="header">
    <button class="btn-sair" onclick="location.reload()">SAIR</button>
    <div style="color: var(--green); font-weight: bold; font-size: 12px;">2 OITAVAS ‚Ä¢ SUSTAIN LISO</div>
    <div style="color: #00BFFF; font-size: 10px;">‚óè MASTER OUT</div>
</div>

<div class="sliders">
    <div class="slider-item">PITCH: <input type="range" id="pitch" min="0.5" max="2.0" step="0.01" value="1.0"></div>
    <div class="slider-item">VOL: <input type="range" id="vol" min="0" max="5" step="0.1" value="2.5"></div>
</div>

<div class="buttons">
    <button class="btn-act" style="background:var(--blue)">ECO: OFF</button>
    <button class="btn-act btn-mic" id="micBtn" onclick="toggleMic()">üé§ GRAVAR (DOCEEEE)</button>
</div>

<div class="keyboard-wrapper">
    <div class="keyboard" id="piano"></div>
</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const masterGain = audioCtx.createGain();
    masterGain.connect(audioCtx.destination);

    let recordedBuffer = null;
    let isRecording = false;
    let mediaRecorder = null;
    let activeNodes = {};

    const notes = [
        {f: 130.81, n: 'D√≥', b: false}, {f: 138.59, n: 'D√≥#', b: true},
        {f: 146.83, n: 'R√©', b: false}, {f: 155.56, n: 'R√©#', b: true},
        {f: 164.81, n: 'Mi', b: false},
        {f: 174.61, n: 'F√°', b: false}, {f: 185.00, n: 'F√°#', b: true},
        {f: 196.00, n: 'Sol', b: false}, {f: 207.65, n: 'Sol#', b: true},
        {f: 220.00, n: 'L√°', b: false}, {f: 233.08, n: 'L√°#', b: true},
        {f: 246.94, n: 'Si', b: false},
        // Oitava 2
        {f: 261.63, n: 'D√≥', b: false}, {f: 277.18, n: 'D√≥#', b: true},
        {f: 293.66, n: 'R√©', b: false}, {f: 311.13, n: 'R√©#', b: true},
        {f: 329.63, n: 'Mi', b: false},
        {f: 349.23, n: 'F√°', b: false}, {f: 369.99, n: 'F√°#', b: true},
        {f: 392.00, n: 'Sol', b: false}, {f: 415.30, n: 'Sol#', b: true},
        {f: 440.00, n: 'L√°', b: false}, {f: 466.16, n: 'L√°#', b: true},
        {f: 493.88, n: 'Si', b: false}
    ];

    const piano = document.getElementById('piano');
    let whiteKeys = [];

    // Primeiro cria as brancas para servir de base de posi√ß√£o
    notes.forEach((nota) => {
        if (!nota.b) {
            const key = document.createElement('div');
            key.className = 'key';
            key.innerHTML = `<span>${nota.n}</span>`;
            key.addEventListener('touchstart', (e) => { e.preventDefault(); start(nota.f, key); });
            key.addEventListener('touchend', () => stop(nota.f, key));
            piano.appendChild(key);
            whiteKeys.push(key);
        }
    });

    // Depois sobrep√µe as pretas nos intervalos corretos
    let whiteIdx = 0;
    notes.forEach((nota) => {
        if (nota.b) {
            const bKey = document.createElement('div');
            bKey.className = 'black-key';
            // C√°lculo de posi√ß√£o para ficar entre as teclas brancas
            const refKey = whiteKeys[whiteIdx];
            const xPos = refKey.offsetLeft + refKey.offsetWidth - 23;
            bKey.style.left = xPos + "px";
            
            bKey.addEventListener('touchstart', (e) => { e.preventDefault(); e.stopPropagation(); start(nota.f, bKey); });
            bKey.addEventListener('touchend', () => stop(nota.f, bKey));
            piano.appendChild(bKey);
        } else {
            // Pula a posi√ß√£o se for Mi ou Si (n√£o tem preta depois)
            if (nota.n !== 'Mi' && nota.n !== 'Si') whiteIdx++;
        }
    });

    function start(freq, el) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        el.classList.add('active');
        const pitchVal = document.getElementById('pitch').value;
        const volVal = document.getElementById('vol').value;

        const g = audioCtx.createGain();
        g.gain.setValueAtTime(volVal, audioCtx.currentTime);

        let src;
        if(!recordedBuffer) {
            src = audioCtx.createOscillator();
            src.type = 'sawtooth';
            src.frequency.value = freq * pitchVal;
        } else {
            src = audioCtx.createBufferSource();
            src.buffer = recordedBuffer;
            src.playbackRate.value = (freq / 261.63) * pitchVal;
            src.loop = true;
            
            // LOGICA PARA O SOM LISO: Pega os √∫ltimos 30% da onda para evitar o "picado"
            const duration = recordedBuffer.duration;
            src.loopStart = duration * 0.7; 
            src.loopEnd = duration;
        }

        // Filtro para tirar "clicks" da emenda do √°udio
        const filter = audioCtx.createBiquadFilter();
        filter.type = "lowpass";
        filter.frequency.value = 7000;

        src.connect(filter);
        filter.connect(g);
        g.connect(masterGain);
        
        src.start();
        activeNodes[freq] = { src, g, startTime: audioCtx.currentTime };
    }

    function stop(freq, el) {
        el.classList.remove('active');
        const node = activeNodes[freq];
        if (node) {
            const elapsed = audioCtx.currentTime - node.startTime;
            const release = Math.max(0, 0.3 - elapsed); // M√≠nimo de 0.3s de tela tocada

            node.g.gain.setTargetAtTime(0, audioCtx.currentTime + release, 0.05);
            node.src.stop(audioCtx.currentTime + release + 0.1);
            delete activeNodes[freq];
        }
    }

    async function toggleMic() {
        const btn = document.getElementById('micBtn');
        if (!isRecording) {
            const s = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(s);
            let ch = [];
            mediaRecorder.ondataavailable = e => ch.push(e.data);
            mediaRecorder.onstop = async () => {
                const b = await (new Blob(ch)).arrayBuffer();
                audioCtx.decodeAudioData(b, buf => { 
                    recordedBuffer = buf; 
                    btn.className = "btn-act btn-mic ready";
                    btn.innerText = "PRONTO PARA TOCAR!";
                });
            };
            mediaRecorder.start();
            isRecording = true;
            btn.className = "btn-act btn-mic recording";
            btn.innerText = "GRAVANDO...";
        } else {
            mediaRecorder.stop();
            isRecording = false;
        }
    }
</script>
</body>
    </html>
    
