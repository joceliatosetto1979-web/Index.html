<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gemini Studio: Ultimate Edition</title>
    <style>
        :root { --neon: #00ff00; --bg: #050505; --panel: #111; --blue: #00f2ff; }
        * { box-sizing: border-box; touch-action: manipulation; }
        body { background: var(--bg); color: white; font-family: 'Orbitron', sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Visualizador de Ondas */
        #visualizer-container { height: 120px; background: #000; border-bottom: 2px solid var(--neon); position: relative; overflow: hidden; }
        canvas { width: 100%; height: 100%; }

        header { background: #000; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        
        .main-content { display: flex; flex: 1; overflow: hidden; }
        #mixer { width: 60px; background: #111; display: flex; flex-direction: column; align-items: center; padding: 10px 0; border-right: 1px solid #222; }
        .fader { appearance: slider-vertical; width: 20px; height: 150px; accent-color: var(--neon); }

        /* Timeline */
        #timeline { flex: 1; overflow-y: auto; padding: 10px; background: repeating-linear-gradient(90deg, transparent, transparent 49px, #222 50px); }
        .track { height: 60px; background: rgba(0,255,0,0.02); margin-bottom: 10px; border-radius: 4px; position: relative; border: 1px solid #1a1a1a; }
        
        .block { 
            position: absolute; height: 40px; top: 10px; background: var(--neon); color: #000;
            border-radius: 4px; font-weight: bold; font-size: 10px; display: flex; align-items: center; 
            justify-content: center; cursor: pointer; box-shadow: 0 0 10px var(--neon);
        }
        .block.selected { border: 2px solid white; box-shadow: 0 0 20px #fff; z-index: 10; }

        /* Painel de Controlo */
        .bottom-area { background: var(--panel); padding: 10px; border-top: 2px solid #222; }
        .btn-row { display: flex; gap: 5px; margin-bottom: 10px; }
        
        #keyboard { display: flex; height: 80px; gap: 2px; overflow-x: auto; }
        .key { min-width: 45px; flex: 1; border-radius: 0 0 5px 5px; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 5px; background: white; color: black; font-weight: bold; font-size: 10px; }
        .black { background: #333; color: white; height: 60%; min-width: 30px; margin: 0 -15px; z-index: 2; }
        .key.active { background: var(--neon) !important; box-shadow: 0 0 20px var(--neon); transform: scaleY(0.95); }

        .btn { border: none; border-radius: 5px; padding: 10px; font-weight: bold; cursor: pointer; flex: 1; text-transform: uppercase; font-size: 10px; }
        .btn-rec { background: #ff0044; color: white; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div id="visualizer-container">
    <canvas id="canvas"></canvas>
    <div style="position:absolute; top:5px; left:10px; color:var(--neon); font-size:10px;">OSCILLOSCOPE_V1</div>
</div>

<header>
    <div style="color:var(--neon); font-weight:bold;">GEMINI_ULTRA_STUDIO</div>
    <button class="btn" style="background:var(--neon); color:black; max-width:100px;" onclick="playAll()">‚ñ∂ MASTER_PLAY</button>
</header>

<div class="main-content">
    <div id="mixer">
        <label style="font-size:8px;">GAIN</label>
        <input type="range" class="fader" min="0" max="1" step="0.1" value="0.8">
    </div>

    <div id="timeline">
        <div class="track" id="tr1"></div>
        <div class="track" id="tr2"></div>
        <div class="track" id="tr3"></div>
    </div>
</div>

<div class="bottom-area">
    <div class="btn-row">
        <button id="recBtn" class="btn btn-rec">üé§ RECORD_SAMPLE</button>
        <button class="btn" style="background:var(--blue); color:black;" onclick="duplicate()">üëØ CLONE</button>
        <button class="btn" style="background:#444; color:white;" onclick="removeBlock()">üóëÔ∏è ERASE</button>
    </div>
    <div id="keyboard"></div>
</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    const bufferLength = analyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);

    let songData = [];
    let selectedId = null;

    // --- OSCILOSC√ìPIO (DESENHO) ---
    const canvas = document.getElementById('canvas');
    const canvasCtx = canvas.getContext('2d');

    function draw() {
        requestAnimationFrame(draw);
        analyser.getByteTimeDomainData(dataArray);
        canvasCtx.fillStyle = '#000';
        canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
        canvasCtx.lineWidth = 2;
        canvasCtx.strokeStyle = '#00ff00';
        canvasCtx.beginPath();
        let sliceWidth = canvas.width * 1.0 / bufferLength;
        let x = 0;
        for (let i = 0; i < bufferLength; i++) {
            let v = dataArray[i] / 128.0;
            let y = v * canvas.height / 2;
            if (i === 0) canvasCtx.moveTo(x, y);
            else canvasCtx.lineTo(x, y);
            x += sliceWidth;
        }
        canvasCtx.lineTo(canvas.width, canvas.height / 2);
        canvasCtx.stroke();
    }
    draw();

    // --- TECLADO INTERATIVO ---
    const notes = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B','C2'];
    const kb = document.getElementById('keyboard');
    notes.forEach((n, i) => {
        const k = document.createElement('div');
        k.className = `key ${n.includes('#') ? 'black' : 'white'}`;
        k.innerHTML = n;
        const speed = Math.pow(2, i/12);
        
        const play = (e) => {
            e.preventDefault(); k.classList.add('active');
            audioCtx.resume();
            let sel = songData.find(s => s.id === selectedId);
            const src = audioCtx.createBufferSource();
            if(sel) {
                src.buffer = sel.buffer;
                src.playbackRate.value = speed;
            } else {
                // Som de teste senoidal se nada estiver selecionado
                const osc = audioCtx.createOscillator();
                osc.frequency.value = 261.63 * speed;
                osc.connect(analyser); analyser.connect(audioCtx.destination);
                osc.start(); osc.stop(audioCtx.currentTime + 0.2);
                return;
            }
            src.connect(analyser); analyser.connect(audioCtx.destination);
            src.start(0);
        };
        k.onmousedown = k.ontouchstart = play;
        k.onmouseup = k.ontouchend = () => k.classList.remove('active');
        kb.appendChild(k);
    });

    // --- GRAVA√á√ÉO ---
    let recorder;
    document.getElementById('recBtn').onclick = async () => {
        if(recorder?.state === "recording") {
            recorder.stop();
            document.getElementById('recBtn').innerText = "üé§ RECORD_SAMPLE";
            return;
        }
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const source = audioCtx.createMediaStreamSource(stream);
        source.connect(analyser); // Mostra a voz no oscilosc√≥pio enquanto grava!

        recorder = new MediaRecorder(stream);
        let chunks = [];
        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = async () => {
            const blob = new Blob(chunks, {type: 'audio/ogg'});
            const arrayBuffer = await blob.arrayBuffer();
            audioCtx.decodeAudioData(arrayBuffer, b => createBlock(b));
        };
        recorder.start();
        document.getElementById('recBtn').innerText = "‚èπ STOP_REC";
    };

    function createBlock(buffer) {
        const id = "blk-" + Date.now();
        const el = document.createElement('div');
        el.className = 'block'; el.id = id; el.innerText = "SAMPLE";
        el.style.left = "10px";
        el.style.width = Math.max(40, buffer.duration * 50) + "px";

        const data = { id, buffer, x: 10 };
        songData.push(data);
        el.onclick = () => select(id);
        document.getElementById('tr1').appendChild(el);
        select(id);
    }

    function select(id) {
        selectedId = id;
        document.querySelectorAll('.block').forEach(b => b.classList.toggle('selected', b.id === id));
    }

    function duplicate() {
        let sel = songData.find(s => s.id === selectedId);
        if(sel) createBlock(sel.buffer);
    }

    function removeBlock() {
        if(selectedId) {
            document.getElementById(selectedId).remove();
            songData = songData.filter(s => s.id !== selectedId);
            selectedId = null;
        }
    }

    function playAll() {
        audioCtx.resume();
        songData.forEach(s => {
            const src = audioCtx.createBufferSource();
            src.buffer = s.buffer;
            src.connect(analyser);
            analyser.connect(audioCtx.destination);
            src.start(audioCtx.currentTime);
        });
    }

    // Ajuste de ecr√£ para o Canvas
    canvas.width = window.innerWidth;
</script>
</body>
</html>
